# FRP 内网穿透 - 一键部署

> 一个脚本，3 分钟搞定内网穿透

## 什么是 FRP？

FRP 让外网可以访问你的内网服务（如 SSH、Web、数据库等）。

**工作原理**：
```
外网用户 → 公网服务器(frps) → 内网机器(frpc) → 本地服务
```

---

## 一键部署

### 服务端部署（公网服务器）

在有公网 IP 的服务器上执行：

```bash
curl -fsSL https://raw.githubusercontent.com/你的仓库/frps-install.sh | sudo bash
```

或手动创建脚本：

```bash
#!/bin/bash
# frps-install.sh - FRP 服务端一键部署
set -e

# 配置
FRP_VERSION="0.65.0"
INSTALL_DIR="/usr/local/frp"

# 颜色输出
GREEN='\033[0;32m'
NC='\033[0m'
echo_info() { echo -e "${GREEN}[INFO]${NC} $1"; }

# 检查 root 权限
if [[ $EUID -ne 0 ]]; then
   echo "请使用 root 权限运行: sudo bash $0"
   exit 1
fi

# 生成随机密码
AUTH_TOKEN=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)
WEB_PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-25)

echo_info "开始安装 FRP 服务端..."

# 下载 FRP
cd /tmp
wget -q https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_linux_amd64.tar.gz
tar -xzf frp_${FRP_VERSION}_linux_amd64.tar.gz

# 安装
mkdir -p ${INSTALL_DIR}
cp frp_${FRP_VERSION}_linux_amd64/frps ${INSTALL_DIR}/
chmod +x ${INSTALL_DIR}/frps

# 创建配置文件
cat > ${INSTALL_DIR}/frps.toml << EOF
bindAddr = "0.0.0.0"
bindPort = 7000

auth.method = "token"
auth.token = "${AUTH_TOKEN}"

webServer.addr = "0.0.0.0"
webServer.port = 7500
webServer.user = "admin"
webServer.password = "${WEB_PASSWORD}"

allowPorts = [{ start = 6000, end = 60000 }]

log.to = "${INSTALL_DIR}/frps.log"
log.level = "info"
log.maxDays = 3
EOF

# 创建 systemd 服务
cat > /etc/systemd/system/frps.service << EOF
[Unit]
Description=FRP Server
After=network.target

[Service]
Type=simple
ExecStart=${INSTALL_DIR}/frps -c ${INSTALL_DIR}/frps.toml
WorkingDirectory=${INSTALL_DIR}
Restart=on-failure
RestartSec=10s
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

# 配置防火墙
if command -v ufw &> /dev/null; then
    ufw allow 7000/tcp
    ufw allow 7500/tcp
    ufw allow 6000:60000/tcp
elif command -v firewall-cmd &> /dev/null; then
    firewall-cmd --permanent --add-port=7000/tcp
    firewall-cmd --permanent --add-port=7500/tcp
    firewall-cmd --permanent --add-port=6000-60000/tcp
    firewall-cmd --reload
fi

# 启动服务
systemctl daemon-reload
systemctl enable frps
systemctl start frps

# 获取公网 IP
SERVER_IP=$(curl -s ifconfig.me || echo "获取失败")

# 输出配置信息
echo ""
echo "========================================="
echo "FRP 服务端安装完成！"
echo "========================================="
echo "服务器 IP: ${SERVER_IP}"
echo "认证 Token: ${AUTH_TOKEN}"
echo "Web 管理面板: http://${SERVER_IP}:7500"
echo "Web 用户名: admin"
echo "Web 密码: ${WEB_PASSWORD}"
echo ""
echo "⚠️  请保存以上信息！"
echo ""
echo "客户端连接配置："
echo "  serverAddr = \"${SERVER_IP}\""
echo "  serverPort = 7000"
echo "  auth.token = \"${AUTH_TOKEN}\""
echo "========================================="

# 保存配置信息
cat > ${INSTALL_DIR}/install_info.txt << EOF
服务器 IP: ${SERVER_IP}
认证 Token: ${AUTH_TOKEN}
Web 管理面板: http://${SERVER_IP}:7500
Web 用户名: admin
Web 密码: ${WEB_PASSWORD}
安装时间: $(date)
EOF
chmod 600 ${INSTALL_DIR}/install_info.txt

echo "配置信息已保存到: ${INSTALL_DIR}/install_info.txt"
```

---

### 客户端部署（内网机器）

在内网机器上执行：

```bash
#!/bin/bash
# frpc-install.sh - FRP 客户端一键部署
set -e

# 配置
FRP_VERSION="0.65.0"
INSTALL_DIR="/usr/local/frp"

# 颜色输出
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'
echo_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
echo_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }

# 检查 root 权限
if [[ $EUID -ne 0 ]]; then
   echo "请使用 root 权限运行: sudo bash $0"
   exit 1
fi

# 交互式配置
echo "========================================="
echo "FRP 客户端配置"
echo "========================================="
read -p "请输入服务端 IP 地址: " SERVER_IP
read -p "请输入认证 Token: " AUTH_TOKEN

echo ""
echo "选择代理类型："
echo "1) SSH 远程登录 (端口 22 -> 6000)"
echo "2) Web 服务 (端口 8080 -> 6001)"
echo "3) 自定义配置"
read -p "请选择 [1-3]: " PROXY_TYPE

echo_info "开始安装 FRP 客户端..."

# 下载 FRP
cd /tmp
wget -q https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_linux_amd64.tar.gz
tar -xzf frp_${FRP_VERSION}_linux_amd64.tar.gz

# 安装
mkdir -p ${INSTALL_DIR}
cp frp_${FRP_VERSION}_linux_amd64/frpc ${INSTALL_DIR}/
chmod +x ${INSTALL_DIR}/frpc

# 创建配置文件
cat > ${INSTALL_DIR}/frpc.toml << EOF
serverAddr = "${SERVER_IP}"
serverPort = 7000

auth.method = "token"
auth.token = "${AUTH_TOKEN}"

log.to = "${INSTALL_DIR}/frpc.log"
log.level = "info"
log.maxDays = 3
EOF

# 根据选择添加代理配置
case $PROXY_TYPE in
    1)
        cat >> ${INSTALL_DIR}/frpc.toml << EOF

[[proxies]]
name = "ssh"
type = "tcp"
localIP = "127.0.0.1"
localPort = 22
remotePort = 6000
transport.useEncryption = true
transport.useCompression = true
EOF
        echo_info "已配置 SSH 代理: ssh root@${SERVER_IP} -p 6000"
        ;;
    2)
        cat >> ${INSTALL_DIR}/frpc.toml << EOF

[[proxies]]
name = "web"
type = "tcp"
localIP = "127.0.0.1"
localPort = 8080
remotePort = 6001
EOF
        echo_info "已配置 Web 代理: http://${SERVER_IP}:6001"
        ;;
    3)
        cat >> ${INSTALL_DIR}/frpc.toml << EOF

# 自定义代理配置（请手动编辑）
# [[proxies]]
# name = "custom"
# type = "tcp"
# localIP = "127.0.0.1"
# localPort = 端口号
# remotePort = 远程端口
EOF
        echo_warn "请手动编辑配置文件: ${INSTALL_DIR}/frpc.toml"
        ;;
esac

# 创建 systemd 服务
cat > /etc/systemd/system/frpc.service << EOF
[Unit]
Description=FRP Client
After=network.target

[Service]
Type=simple
ExecStart=${INSTALL_DIR}/frpc -c ${INSTALL_DIR}/frpc.toml
WorkingDirectory=${INSTALL_DIR}
Restart=always
RestartSec=10s
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
systemctl daemon-reload
systemctl enable frpc
systemctl start frpc

# 输出结果
echo ""
echo "========================================="
echo "FRP 客户端安装完成！"
echo "========================================="
echo "服务端: ${SERVER_IP}:7000"
echo "配置文件: ${INSTALL_DIR}/frpc.toml"
echo "日志文件: ${INSTALL_DIR}/frpc.log"
echo ""
echo "管理命令："
echo "  查看状态: systemctl status frpc"
echo "  查看日志: tail -f ${INSTALL_DIR}/frpc.log"
echo "  重启服务: systemctl restart frpc"
echo "========================================="
```

---

## 使用示例

### SSH 远程登录

```bash
# 客户端配置后，从外网访问：
ssh root@服务器IP -p 6000
```

### Web 服务访问

```bash
# 浏览器访问：
http://服务器IP:6001
```

---

## 常用命令

```bash
# 服务端
systemctl status frps    # 查看状态
systemctl restart frps   # 重启服务
tail -f /usr/local/frp/frps.log  # 查看日志

# 客户端
systemctl status frpc    # 查看状态
systemctl restart frpc   # 重启服务
tail -f /usr/local/frp/frpc.log  # 查看日志
```

---

## 故障排查

### 客户端连接失败

```bash
# 1. 检查服务端是否运行
systemctl status frps

# 2. 检查防火墙
ufw status
firewall-cmd --list-ports

# 3. 检查 Token 是否一致
cat /usr/local/frp/frps.toml | grep token
cat /usr/local/frp/frpc.toml | grep token

# 4. 查看日志
tail -f /usr/local/frp/frps.log
tail -f /usr/local/frp/frpc.log
```

---

## 安全建议

1. **使用强密码**：Token 和 Web 密码必须复杂
2. **限制端口**：只开放必要的端口范围
3. **启用加密**：在配置中启用 `useEncryption`
4. **定期更新**：及时更新 FRP 版本
5. **监控日志**：定期检查访问日志

---

## 参考资料

- 官方文档：https://gofrp.org/
- GitHub：https://github.com/fatedier/frp
- 下载地址：https://github.com/fatedier/frp/releases
